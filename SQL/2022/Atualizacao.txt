CREATE OR ALTER PROCEDURE HIST_LEITURA_COCHO (ID_FAZENDA INTEGER)
RETURNS(
  ID_LOTE INTEGER,
  ID_CURRAL INTEGER,
  DATA_LEITURA DATE,
  NOTA DECIMAL(15,3),
  AJUSTE DECIMAL(15,3)
)
AS 
declare variable I integer;
BEGIN    
 FOR SELECT ID FROM LOTE_NUTRICIONAL ln2 
 WHERE STATUS =1
 INTO:ID_LOTE 
 DO 
 BEGIN
  FOR SELECT FIRST 7 ID_CURRAL,DATA_LEITURA,NOTA,AJUSTE FROM leitura_cocho A
  WHERE STATUS=1 AND ID_LOTE=:ID_LOTE
  ORDER BY A.data_leitura DESC
  INTO:ID_CURRAL,:DATA_LEITURA,:NOTA,:AJUSTE
  DO
  BEGIN
   SUSPEND;
  END
 END
END;

SET TERM ^ ;

SET TERM ^ ;

create or alter procedure HIST_CONSUMO_LOTE (
    ID_FAZENDA integer)
returns (
    ID_CURRAL integer,
    ID_LOTE integer,
    DATA_CONSUMO date,
    MN decimal(15,3),
    MS decimal(15,3),
    IMSPV decimal(15,3))
as
declare variable I integer;
BEGIN    
 FOR SELECT ID FROM LOTE_NUTRICIONAL ln2 
 WHERE STATUS =1
 INTO:ID_LOTE 
 DO 
 BEGIN
  FOR SELECT
   FIRST 7
   A.ID_LOTE,
   A.ID_LOCAL,
   A.data_forn,
   AVG(CAST(A.REALIZADO_MN_KG AS DOUBLE PRECISION)/CAST(A.QTD_CAB AS DOUBLE PRECISION)) ConsumoMn,
   AVG(CAST(A.REALIZADO_MN_KG AS DOUBLE PRECISION)/CAST(A.QTD_CAB AS DOUBLE PRECISION)*
    (CAST(MS_RACAO AS DOUBLE PRECISION)/100))ConsumoMs,
   AVG((((CAST(A.REALIZADO_MN_KG AS DOUBLE PRECISION)/A.QTD_CAB)*(CAST(A.MS_RACAO AS DOUBLE PRECISION)/100)*100)/
   CAST(MEDIA_PESO AS DOUBLE PRECISION)))IMS_PV
  FROM FORNECIMENTO_CONF A
  WHERE STATUS=1 AND A.REALIZADO_MN_KG >0 AND ID_LOTE=:ID_LOTE
  GROUP BY A.ID_LOTE,A.ID_LOCAL,A.data_forn
  ORDER BY A.DATA_FORN DESC
  INTO:ID_LOTE,:ID_CURRAL,:DATA_CONSUMO,:MN,:MS,:IMSPV
  DO
  BEGIN
   SUSPEND;
  END
 END^

SET TERM ; ^







CREATE trigger fabricacao_insumos_ai_1 for fabricacao_insumos
active after insert position 0
AS
begin
  UPDATE fabricacao SET custo_total =(SELECT SUM(custo) FROM fabricacao_insumos
  WHERE STATUS=1 AND ID_FABRICACAO=NEW.ID_FABRICACAO)
  WHERE ID=NEW.ID_FABRICACAO;
end